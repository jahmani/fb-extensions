<ng-container *ngIf=" products$|async as products">



  <ion-header>
    <ion-toolbar>

      <ion-title>
        products
      </ion-title>
      <ion-buttons slot="start">
        <ng-container *ngIf="slideView;else showNewButton">
          <ion-back-button [defaultHref]="'store/'+storeId+'/products'"></ion-back-button>
        </ng-container>
        <ng-template #showNewButton>
          <ng-container *ngIf="user|async as userInfo">
            <ion-thumbnail class="small-thumb" slot="end" *ngIf="userInfo && userInfo.photoURL">
              <ion-img [src]="userInfo.photoURL" />
            </ion-thumbnail>
          </ng-container>
        </ng-template>

      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button [routerLink]="['../edit-product', 'new']" routerLinkActive="router-link-active">
          <ion-icon slot="start" name="create"></ion-icon>
          <span>جديد</span>
        </ion-button>

        <ion-button (click)="logout()">
          <ion-icon slot="start" name="log-out-outline"></ion-icon>
          <span>خروج</span>
        </ion-button>

      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ng-container *ngIf="slideView;else templateName">

      <ng-container *ngIf="dynamicSlidesComponent;else loadingSlidesTemplate">
        <ng-template
          *ngComponentOutlet="dynamicSlidesComponent; inputs:{products:ProductsInstance, intialSlideIndex:intialSlideIndex} ">
        </ng-template>
      </ng-container>
      <ng-template #loadingSlidesTemplate>
        <ion-skeleton-text animated style="width: 100%; height: 100%;"></ion-skeleton-text>
      </ng-template>

      <!-- <store-app-repository-products-slides-view [products]="ProductsInstance"
        [intialSlideIndex]="intialSlideIndex"></store-app-repository-products-slides-view> -->
    </ng-container>
    <ng-template #templateName>

      <cdk-virtual-scroll-viewport itemSize="auto" class="ion-content-scroll-host">

        <ng-template #noDocCount>
          <ion-item>
            <ion-label> <ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></ion-label>
          </ion-item>
        </ng-template>

        <div class="gallary_container" *ngIf="!loaded;">
          <ng-container
            *ngFor="let  prod of [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]; let i=index">
            <div class="image_container">
              <ion-skeleton-text animated style="width: 100%; height: 100%;"></ion-skeleton-text>
            </div>
          </ng-container>
        </div>
        <div class="gallary_container" *ngIf=" products$|async as products ">

          <ng-container *ngFor="let  prod of ProductsInstance; trackBy: trackBy; let i=index">
            <div class="image_container"
              (click)="previewProduct === prod ? previewProduct= null : previewProduct = prod">
              <img style="object-fit: cover;" *ngIf="prod!.imageIds && prod!.imageIds![0]; else noImg"
                [src]="prod!.imageIds![0]|imgIdtoThumbUre:200" alt="{{prod.name}}" priority="i<22" fill />
              <ng-template #noImg>
                <img style="object-fit: cover;" ngSrc="../../../assets/imgs/noimg.jpg" alt="{{prod.name}}"
                  priority="i<22" fill />
              </ng-template>
            </div>
            <div class="prod-preview" *ngIf="previewProduct === prod" routerLink=""
              [queryParams]="{productId: prod.id}">
              <div class="prod-preview-content">

                <div class="card " style="flex: auto;">
                  <ion-fab vertical="top" horizontal="start" slot="fixed">
                    <ion-fab-button class="button-transparent" (click)="previewProduct = null">
                      <ion-icon name="chevron-collapse-outline"></ion-icon>
                    </ion-fab-button>
                  </ion-fab>
                  <div class=" card-content">
                    <div class="slides top-scrollbars">
                      <ng-container *ngIf="prod.imageIds && prod.imageIds[0]; else noImg">
                        <div id="slide-1" class=" image_container" *ngFor="let item of prod!.imageIds">
                          <ion-spinner name="bubbles" class="big-spinner" *ngIf="hImage.isLoading"></ion-spinner>
                          <img loading="lazy" #hImage="storeAppRepositoryHydratedImg" [src]="item |imgIdtoThumbUre:200"
                            [storeAppRepositoryHydratedImg]="item |imgIdtoThumbUre:600" alt="{{prod.name}}" fill />
                        </div>
                      </ng-container>
                      <ng-template #noImg>
                        <div id="slide-1" class=" image_container">
                          <img ngSrc="../../../assets/imgs/noimg.jpg" alt="{{prod.name}}" fill />
                        </div>
                      </ng-template>

                    </div>
                  </div>
                  <ion-text class="card-title">
                    <span>{{prod.name}}</span>
                  </ion-text>

                </div>
              </div>

            </div>
            <ng-container *ngIf="products.length < 2">
              <div class="image_container placeholder">
              </div>
            </ng-container>
            <ng-container *ngIf="products.length < 3">
              <div class="image_container placeholder">
              </div>
            </ng-container>
          </ng-container>




        </div>
        <ion-infinite-scroll threshold="0" (ionInfinite)="onInfinitScroll($event)">
          <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Loading more data...">
          </ion-infinite-scroll-content>
        </ion-infinite-scroll>

      </cdk-virtual-scroll-viewport>

    </ng-template>

  </ion-content>
  <ion-footer [class.zero-hieght]="slideView">

    <ion-toolbar>
      <ng-container *ngIf="networkStatus$|async">
        <div slot="end" class="ion-margin-horizontal" *ngIf="docCount$|async as count">
          <ion-label> <ion-icon name="stats-chart-outline"></ion-icon>
            {{count}} products</ion-label>
        </div>
      </ng-container>

      <ion-title slot="secondary"></ion-title>
      <ion-buttons slot="start">
        <ng-container *ngIf="isFilterModalVisable; else showDropUpButton">
          <ion-button (click)="isFilterModalVisable = !isFilterModalVisable">
            <ion-icon slot="start" name="chevron-down-circle-outline"></ion-icon> hide
          </ion-button>

        </ng-container>
        <ng-template #showDropUpButton>
          <div style="    display: flex;
          align-items: center;
          border-radius: 15px;" *ngIf="{filterText: filterText$|async} as filterData">
            <div style="  
            flex-wrap: nowrap;
            display: flex;
            align-items: center;" (click)="isFilterModalVisable = !isFilterModalVisable">
              <ion-icon slot="start" name="search-outline"></ion-icon>
              <span>{{filterData.filterText || 'بحث'}}</span>
            </div>
            <ion-icon slot="end" name="close" (click)="filterFormControl.patchValue([])"
              *ngIf=" filterFormControl.value?.length"></ion-icon>
          </div>
        </ng-template>
      </ion-buttons>
    </ion-toolbar>
    <div [hidden]="!isFilterModalVisable">
      <store-app-repository-product-filter #productFilterForm
        [formControl]="filterFormControl"></store-app-repository-product-filter>
    </div>

  </ion-footer>

</ng-container>